<!DOCTYPE html>

<body>
    <script src="/em_random_gen.js"></script>
    <script>
        Bindings = {};
        Module.onRuntimeInitialized = () => {
            //this handler will be called from emscripten to initialize the context
            window.setWorklet = function (context, workletNode) {
                function _start() {
                    document.removeEventListener('click', _start);
                    if (context.state !== "running") {
                        context.resume();
                    }

                    let main_g = context.createGain(),
                        bps = [
                            {
                                bp: context.createBiquadFilter(),
                                g: context.createGain()
                            },
                            {
                                bp: context.createBiquadFilter(),
                                g: context.createGain()
                            },
                            {
                                bp: context.createBiquadFilter(),
                                g: context.createGain()
                            },
                            {
                                bp: context.createBiquadFilter(),
                                g: context.createGain()
                            },
                            {
                                bp: context.createBiquadFilter(),
                                g: context.createGain()
                            },
                            {
                                bp: context.createBiquadFilter(),
                                g: context.createGain()
                            }
                        ].forEach((bpo, i, a) => {
                            bpo.bp.type = 'bandpass';
                            bpo.bp.frequency.value = Math.random() * 400 + 40;
                            bpo.bp.Q.value = 1000;

                            workletNode
                                .connect(bpo.bp)
                                .connect(bpo.g)
                                .connect(main_g);

                            let bpn = a.length;
                            let bpog = bpo.g;
                            bpog.gain.setValueAtTime(.0000001, context.currentTime);
                            bpog.gain.exponentialRampToValueAtTime((bpn * 4), context.currentTime + 10);
                            bpog.gain.exponentialRampToValueAtTime((bpn * 8), context.currentTime + 20);
                            bpog.gain.exponentialRampToValueAtTime((bpn * 6), context.currentTime + 30);
                            bpog.gain.exponentialRampToValueAtTime((bpn * 4), context.currentTime + 40);

                            let bpoq = bpo.bp.Q;
                            bpoq.setValueAtTime(bpoq.value, context.currentTime);
                            bpoq.exponentialRampToValueAtTime(Math.random() * 1000 + 1000, context.currentTime + 10);
                            bpoq.exponentialRampToValueAtTime(Math.random() * 1000 + 1000, context.currentTime + 20);
                            bpoq.exponentialRampToValueAtTime(Math.random() * 1000 + 1000, context.currentTime + 60);

                            let bpof = bpo.bp.frequency;
                            bpof.setValueAtTime(bpof.value, context.currentTime);
                            bpof.exponentialRampToValueAtTime(Math.random() * 400 + 40, context.currentTime + 30);
                            bpof.exponentialRampToValueAtTime(Math.random() * 400 + 40, context.currentTime + 60);
                            bpof.exponentialRampToValueAtTime(Math.random() * 400 + 40, context.currentTime + 240);
                        });

                    main_g.gain.value = 20;
                    main_g.connect(context.destination);
                }
                document.addEventListener('click', _start);
            };
        };
    </script>
</body>

</html>
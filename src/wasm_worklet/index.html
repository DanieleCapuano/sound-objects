<!DOCTYPE html>

<head>
    <style>
        canvas {
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>

<body>
    <!-- <canvas></canvas> -->
    <script src="/em_random_gen.js"></script>
    <script>
        Bindings = {};
        Module.onRuntimeInitialized = () => {
            //this handler will be called from emscripten to initialize the context
            window.setWorklet = function (context, worklet) {
                function _start() {
                    document.removeEventListener('click', _start);
                    if (context.state !== "running") {
                        context.resume();
                    }

                    let main_g = context.createGain(),
                        bps = [
                            {
                                bp: context.createBiquadFilter(),
                                g: context.createGain()
                            },
                            {
                                bp: context.createBiquadFilter(),
                                g: context.createGain()
                            },
                            {
                                bp: context.createBiquadFilter(),
                                g: context.createGain()
                            },
                            {
                                bp: context.createBiquadFilter(),
                                g: context.createGain()
                            },
                            {
                                bp: context.createBiquadFilter(),
                                g: context.createGain()
                            },
                            {
                                bp: context.createBiquadFilter(),
                                g: context.createGain()
                            }
                        ].forEach((bpo, i, a) => {
                            bpo.bp.frequency.value = Math.random() * 600 + 40;
                            bpo.bp.Q.value = 5000;

                            worklet.connect(bpo.bp).connect(bpo.g).connect(i > 0 ? main_g.gain : main_g);

                            let bpn = a.length;
                            let bpog = bpo.g;
                            bpo.bp.gain.value = 1 / bpn;
                            bpog.gain.setValueAtTime(.0000001, context.currentTime);
                            bpog.gain.exponentialRampToValueAtTime(1 / (bpn * 2), context.currentTime + 10);
                            bpog.gain.exponentialRampToValueAtTime(1 / (bpn * 4), context.currentTime + 20);
                            bpog.gain.exponentialRampToValueAtTime(1 / (bpn * 3), context.currentTime + 30);
                            bpog.gain.exponentialRampToValueAtTime(1 / (bpn * 2), context.currentTime + 40);

                            let bpoq = bpo.bp.Q;
                            bpoq.setValueAtTime(bpoq.value, context.currentTime);
                            bpoq.exponentialRampToValueAtTime(Math.random() * 2000 + 3000, context.currentTime + 10);
                            bpoq.exponentialRampToValueAtTime(Math.random() * 2000 + 3000, context.currentTime + 20);
                            bpoq.exponentialRampToValueAtTime(Math.random() * 2000 + 3000, context.currentTime + 60);

                            let bpof = bpo.bp.frequency;
                            bpof.setValueAtTime(bpof.value, context.currentTime);
                            bpof.exponentialRampToValueAtTime(Math.random() * 600 + 40, context.currentTime + 30);
                            bpof.exponentialRampToValueAtTime(Math.random() * 600 + 40, context.currentTime + 60);
                            bpof.exponentialRampToValueAtTime(Math.random() * 600 + 40, context.currentTime + 240);
                        });
                    main_g.connect(context.destination);
                }
                document.addEventListener('click', _start);
            };
        };
    </script>
</body>

</html>